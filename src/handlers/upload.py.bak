from js import Response
import json
import uuid

# Função assíncrona, permite atender várias requisoções ao mesmo tempo e aguardar operações
# Essencial para o Cloudflare Workers

async def handle_upload(request, env):
    """ Endpoint para upload de documentos """
   # Parse do form data
   form_data = await request.formData()

   # Extração dos campos
   file = form_data.get("file")
   title = form_data.get("title")
   doc_type = form_data.get("type")
   sector = form_data.get("sector")
   
   if not all([file, title, doc_type, sector]):
    return Response.json(
        {"error": "Missing required fields: file, title, type, sector"},
        status=400
    )
   
  # Gerar ID único para o documento
  document_id = str(uuid.uuid4())
  r2_key = f"documents/{sector}/{document_id}.pdf"

  # Obter o conteúdo do arquivo
  file_content = await file.arrayBuffer()
  file_size = len(file_content)

  # Salvar no R2
  await env.R2_BUCKET.put(r2_key, file_content)

  # Registrar metadados no D1
  await env.DB.prepare("""
    INSERT INTO documents (id, title, type, sector, r2_key, file_size, status) 
    VALUES (?, ?, ?, ?, ?, ?, 'pending')""").bind(document_id, title, doc_type, sector, r2_key, file_size).run() 

    return Response.json({
        "success": True,
        "document_id": document_id,
        "message": "Documento enviado com sucesso. Use /documents/{id}/process para iniciar o processamento."
    }) 